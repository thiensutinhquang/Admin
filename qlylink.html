<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Liên kết YouTube cho NotebookLM</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Subtle background gradient */
            background: linear-gradient(to bottom right, #f0f4f8, #e2e8f0);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 40px; /* Increased padding */
            border-radius: 20px; /* More rounded corners */
            /* Softer, more modern shadow */
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0, 0, 0, 0.08);
            max-width: 650px; /* Slightly wider container */
            width: 100%;
            text-align: center;
            border: 1px solid #d1d5db; /* Subtle border */
        }
        textarea {
            resize: vertical;
            min-height: 150px; /* Taller textarea */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        textarea:focus {
            border-color: #6366f1; /* Indigo focus ring */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); /* Custom focus ring */
        }
        .button-primary {
            background-color: #4f46e5; /* Indigo 600 */
            color: #ffffff;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.125rem; /* text-lg */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex; /* Flex for icon and text */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
        }
        .button-primary:hover {
            background-color: #4338ca; /* Indigo 700 */
            transform: translateY(-2px); /* Slightly more pronounced lift */
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2); /* More prominent shadow on hover */
        }
        .button-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .button-secondary {
            background-color: #10b981; /* Emerald 500 */
            color: #ffffff;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.125rem;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex; /* Flex for icon and text */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
        }
        .button-secondary:hover {
            background-color: #059669; /* Emerald 600 */
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }
        .button-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .button-tertiary { /* For clear button */
            background-color: #ef4444; /* Red 500 */
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: background-color 0.2s ease-in-out;
            display: flex; /* Flex for icon and text */
            align-items: center;
            justify-content: center;
            gap: 4px; /* Space between icon and text */
        }
        .button-tertiary:hover {
            background-color: #dc2626; /* Red 600 */
        }

        /* Styling for the copy confirmation message */
        .copy-message {
            opacity: 0;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; /* Added transform transition */
            padding: 8px 16px;
            border-radius: 8px;
            margin-top: 10px;
            display: inline-block; /* To make padding and border visible */
            transform: translateY(10px); /* Start slightly below */
        }
        .copy-message.show {
            opacity: 1;
            transform: translateY(0); /* Move to original position */
        }
        .copy-message.success {
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
            border: 1px solid #34d399; /* Green 400 */
        }
        .copy-message.error {
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 800 */
            border: 1px solid #f87171; /* Red 400 */
        }

        /* Styling for current link display */
        #currentLink {
            background-color: #f8fafc; /* Lighter gray */
            border: 1px solid #e2e8f0; /* Light border */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Inner shadow */
            transition: border-color 0.2s, box-shadow 0.2s; /* Smooth transition */
        }
        #currentLink.completed-state {
            background-color: #ecfdf5; /* Light green for completion */
            border-color: #34d399; /* Green border */
            color: #065f46; /* Darker green text */
            font-weight: 600;
        }
        #currentLink:hover {
            border-color: #93c5fd; /* Light blue on hover */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08), 0 0 0 2px rgba(147, 197, 253, 0.5); /* Subtle outer glow */
        }

        /* Instructions section */
        .instructions {
            background-color: #eff6ff; /* Blue 50 */
            border-left: 5px solid #60a5fa; /* Blue 400 */
            padding: 20px;
            border-radius: 12px;
            text-align: left;
            margin-top: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .instructions p {
            font-weight: 700; /* Bolder */
            color: #1e40af; /* Blue 800 */
            margin-bottom: 12px;
            font-size: 1.1rem; /* Slightly larger */
        }
        .instructions ol {
            list-style-type: decimal;
            list-style-position: inside;
            color: #374151; /* Gray 700 */
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .instructions ol li {
            margin-bottom: 6px;
        }

        /* LLM Summary Section */
        #summarySection {
            background-color: #f0fdf4; /* Light green background */
            padding: 24px;
            border-radius: 12px;
            margin-top: 24px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.08);
            text-align: left;
        }
        #summaryOutput {
            background-color: #ffffff;
            border: 1px solid #d1fae5; /* Green 100 border */
            padding: 16px;
            border-radius: 8px;
            min-height: 80px;
            color: #1f2937; /* Gray 800 */
            line-height: 1.6;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.03); /* Subtle inner shadow */
            animation: fadeIn 0.5s ease-out; /* Fade in animation for summary */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Style for disabled buttons */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-5">
    <div class="container">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-8">Quản lý Liên kết YouTube</h1>

        <!-- Input Section -->
        <div class="mb-6 text-left">
            <label for="linkInput" class="block text-gray-700 text-base font-medium mb-2">
                Dán danh sách liên kết YouTube vào đây (mỗi liên kết một dòng):
            </label>
            <div class="relative">
                <textarea
                    id="linkInput"
                    class="w-full p-4 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 text-gray-800 shadow-sm"
                    placeholder="Ví dụ:&#x0A;https://www.youtube.com/watch?v=video1&#x0A;https://youtu.be/video2&#x0A;https://www.youtube.com/watch?v=another_video"
                ></textarea>
                <button
                    id="clearLinksBtn"
                    class="button-tertiary absolute top-3 right-3"
                    title="Xóa tất cả liên kết"
                >
                    <!-- Trash Can SVG Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                    Xóa
                </button>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-center mb-8 gap-4">
            <!-- Copy Link Button -->
            <button
                id="copyLinkBtn"
                class="button-primary w-full sm:w-auto flex-grow"
            >
                <!-- Copy SVG Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                <span id="copyButtonText">Sao chép Liên kết</span>
            </button>
            <!-- Initial Link count display, with colored number -->
            <span id="initialLinkCount" class="text-red-800 text-xl font-bold whitespace-nowrap mt-4 sm:mt-0">
                Bạn đang có: <span class="text-purple-700">0</span> liên kết.
            </span>
        </div>


        <!-- Display Section -->
        <div id="linkDisplayArea" class="">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Liên kết Hiện tại:</h2>
            <p id="currentLink" class="bg-gray-50 p-5 border border-gray-200 rounded-lg text-gray-900 break-words mb-4 text-lg font-mono shadow-inner">
                Chưa có liên kết nào được hiển thị.
            </p>

            <!-- Copy Confirmation Message -->
            <p id="copyConfirmationMessage" class="copy-message font-medium text-center mb-4">
                <!-- Message will be displayed here -->
            </p>

            <!-- LLM Feature Button -->
            <button
                id="summarizeVideoBtn"
                class="button-secondary w-full py-3 px-6 rounded-lg font-semibold text-lg hover:bg-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-50 shadow-md mb-6"
            >
                <!-- Sparkle SVG Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="M9.9 10.8c.3.9.9 1.6 1.6 1.6H22l-2.7-2.7c-.7-.7-1.6-1.2-2.5-1.4"/><path d="M14.2 2.2c-.3.9-.9 1.6-1.6 1.6H2l2.7 2.7c.7.7 1.6 1.2 2.5 1.4"/><path d="M10.8 14.2c.9-.3 1.6-.9 1.6-1.6V2L9.9 4.7c-.7.7-1.2 1.6-1.4 2.5"/><path d="M2.2 9.9c.9.3 1.6.9 1.6 1.6V22l2.7-2.7c.7-.7 1.2-1.6 1.4-2.5"/></svg>
                Tóm tắt Video
            </button>

            <!-- LLM Summary Section -->
            <div id="summarySection" class="hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Trợ lý Tóm tắt Video (bởi Gemini)</h3>
                
                <!-- Prompt Suggestions -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <button class="prompt-suggestion-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-300 transition-colors">
                        Tóm tắt ngắn
                    </button>
                    <button class="prompt-suggestion-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-300 transition-colors">
                        Các điểm chính
                    </button>
                    <button class="prompt-suggestion-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-300 transition-colors">
                        Tạo FAQ
                    </button>
                    <button class="prompt-suggestion-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-300 transition-colors">
                        Viết mô tả video
                    </button>
                </div>

                <label for="summaryPromptInput" class="block text-gray-700 text-sm font-medium mb-2">
                    Nhập yêu cầu tóm tắt của bạn:
                </label>
                <textarea
                    id="summaryPromptInput"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-800 mb-4"
                    placeholder="Ví dụ: Tóm tắt nội dung chính của video này."
                    rows="3"
                ></textarea>
                <button
                    id="generateSummaryBtn"
                    class="button-primary bg-indigo-500 hover:bg-indigo-600 focus:ring-indigo-500 py-2 px-5 text-base rounded-lg shadow-sm mb-4"
                >
                    Tạo Tóm tắt
                </button>
                <div id="summaryLoader" class="hidden loader my-4"></div>
                <div id="summaryOutput" class="mb-4">
                    <!-- Summary will be displayed here -->
                </div>
                <button
                    id="copySummaryBtn"
                    class="button-secondary bg-blue-500 hover:bg-blue-600 focus:ring-blue-500 py-2 px-5 text-base rounded-lg shadow-sm mb-4 hidden"
                >
                    <!-- Copy SVG Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                    <span id="copySummaryButtonText">Sao chép Tóm tắt</span>
                </button>
                <button
                    id="closeSummaryBtn"
                    class="bg-gray-300 text-gray-800 py-2 px-5 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 text-base shadow-sm"
                >
                    Đóng
                </button>
            </div>

            <!-- Remaining Link count display, with colored number -->
            <p id="linkCount" class="text-red-800 text-xl font-bold mb-6">
                Còn lại: <span class="text-purple-700">0</span> liên kết.
            </p>

            <!-- Instructions -->
            <div class="instructions">
                <p>Hướng dẫn:</p>
                <ol>
                    <li>Dán danh sách liên kết YouTube vào ô nhập liệu.</li>
                    <li>Nhấp vào nút "Sao chép Liên kết" để sao chép liên kết hiện tại vào khay nhớ tạm. Liên kết sẽ tự động bị xóa khỏi danh sách và bộ đếm sẽ cập nhật.</li>
                    <li>Mở dự án NotebookLM của bạn.</li>
                    <li>Nhấp vào nút "Thêm nguồn" (Add source).</li>
                    <li>Chọn "Liên kết" (Link) và sau đó chọn "URL YouTube" (YouTube URL).</li>
                    <li>Dán liên kết đã sao chép vào trường nhập liệu.</li>
                    <li>Nhấn "Thêm" (Add) hoặc "Chèn" (Insert).</li>
                    <li>Quay lại ứng dụng này để sao chép liên kết tiếp theo.</li>
                    <li>Sử dụng nút "Tóm tắt Video ✨" để nhận tóm tắt từ AI về liên kết hiện tại.</li>
                    <li>Sau khi có tóm tắt, bạn có thể nhấp vào "Sao chép Tóm tắt" để sao chép nội dung tóm tắt.</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const linkInput = document.getElementById('linkInput');
        const clearLinksBtn = document.getElementById('clearLinksBtn'); // New clear button
        const initialLinkCountElement = document.getElementById('initialLinkCount');
        const linkDisplayArea = document.getElementById('linkDisplayArea');
        const currentLinkElement = document.getElementById('currentLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const copyButtonText = document.getElementById('copyButtonText'); // Span for copy button text
        const linkCountElement = document.getElementById('linkCount');
        const copyConfirmationMessage = document.getElementById('copyConfirmationMessage');

        // LLM Feature Elements
        const summarizeVideoBtn = document.getElementById('summarizeVideoBtn');
        const summarySection = document.getElementById('summarySection');
        const summaryPromptInput = document.getElementById('summaryPromptInput');
        const generateSummaryBtn = document.getElementById('generateSummaryBtn');
        const summaryLoader = document.getElementById('summaryLoader');
        const summaryOutput = document.getElementById('summaryOutput');
        const closeSummaryBtn = document.getElementById('closeSummaryBtn');
        const copySummaryBtn = document.getElementById('copySummaryBtn'); // New copy summary button
        const copySummaryButtonText = document.getElementById('copySummaryButtonText'); // Span for copy summary button text
        const promptSuggestionButtons = document.querySelectorAll('.prompt-suggestion-btn'); // New prompt suggestion buttons

        let links = []; // Array to store processed links
        let messageTimeout; // To store the timeout ID for hiding the message
        let copyButtonTimeout; // To store the timeout ID for copy button text change
        let copySummaryButtonTimeout; // To store the timeout ID for copy summary button text change

        // Function to show a temporary message within the app
        function showTemporaryMessage(message, isError = false) {
            // Clear any existing timeout to prevent messages from overlapping
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }

            copyConfirmationMessage.textContent = message;
            // Remove all color classes first
            copyConfirmationMessage.classList.remove('success', 'error'); 
            // Add appropriate color and show class
            copyConfirmationMessage.classList.add(isError ? 'error' : 'success', 'show'); 

            // Hide the message after 3 seconds
            messageTimeout = setTimeout(() => {
                copyConfirmationMessage.classList.remove('show');
                copyConfirmationMessage.textContent = ''; // Clear text after hiding
            }, 3000); // Message visible for 3 seconds
        }

        // Function to display the current link and update count
        function displayCurrentLink() {
            // Update the internal 'links' array from the textarea content
            const rawInput = linkInput.value;
            links = rawInput.split('\n')
                            .map(link => link.trim())
                            .filter(link => link !== '');

            if (links.length === 0) {
                currentLinkElement.textContent = 'Đã xử lý tất cả liên kết!';
                currentLinkElement.classList.add('completed-state'); // Add completion state class
                linkCountElement.innerHTML = `Còn lại: <span class="text-purple-700">0</span> liên kết.`;
                showTemporaryMessage('Bạn đã xử lý tất cả các liên kết.');
                copyLinkBtn.disabled = true; // Disable copy button if no links
                summarizeVideoBtn.disabled = true; // Disable summarize button if no links
                summarySection.classList.add('hidden'); // Hide summary section if no links
                summaryOutput.textContent = ''; // Clear summary output
                summaryPromptInput.value = ''; // Clear summary prompt
                copySummaryBtn.classList.add('hidden'); // Hide copy summary button
                return;
            }

            currentLinkElement.textContent = links[0]; // Always display the first link in the remaining list
            currentLinkElement.classList.remove('completed-state'); // Remove completion state class
            linkCountElement.innerHTML = `Còn lại: <span class="text-purple-700">${links.length}</span> liên kết.`;
            copyLinkBtn.disabled = false; // Enable copy button if there are links
            summarizeVideoBtn.disabled = false; // Enable summarize button if there are links
        }

        // Function to update the initial link count display
        function updateInitialLinkCount() {
            const rawInput = linkInput.value;
            const currentLinks = rawInput.split('\n')
                                        .map(link => link.trim())
                                        .filter(link => link !== '');
            initialLinkCountElement.innerHTML = `Bạn đang có: <span class="text-purple-700">${currentLinks.length}</span> liên kết.`;
            
            // Also update the main display area's current link and remaining count
            displayCurrentLink();
        }

        // Event listener for input changes in the textarea
        linkInput.addEventListener('input', updateInitialLinkCount);

        // Event listener for the "Clear Links" button
        clearLinksBtn.addEventListener('click', () => {
            linkInput.value = ''; // Clear the textarea
            updateInitialLinkCount(); // Update counts and display
            showTemporaryMessage('Đã xóa tất cả liên kết khỏi danh sách.');
            summarySection.classList.add('hidden'); // Hide summary section if open
            summaryOutput.textContent = ''; // Clear summary output
            summaryPromptInput.value = ''; // Clear summary prompt
            copySummaryBtn.classList.add('hidden'); // Hide copy summary button
        });

        // Event listener for the "Copy Link" button
        copyLinkBtn.addEventListener('click', () => {
            if (links.length > 0) {
                const linkToCopy = links[0]; // Always copy the first link

                const textArea = document.createElement('textarea');
                textArea.value = linkToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showTemporaryMessage('Đã sao chép liên kết vào khay nhớ tạm!');

                    // Visual feedback on button
                    copyButtonText.textContent = 'Đã Sao Chép!';
                    copyLinkBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    copyLinkBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');

                    if (copyButtonTimeout) {
                        clearTimeout(copyButtonTimeout);
                    }
                    copyButtonTimeout = setTimeout(() => {
                        copyButtonText.textContent = 'Sao chép Liên kết';
                        copyLinkBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        copyLinkBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    }, 1500); // Revert after 1.5 seconds


                    // Remove the copied link from the array
                    links.shift(); // Removes the first element from the array
                    
                    // Update the textarea with the remaining links
                    linkInput.value = links.join('\n'); 
                    
                    updateInitialLinkCount(); // Update both counters and display
                } catch (err) {
                    console.error('Không thể sao chép liên kết: ', err);
                    showTemporaryMessage('Không thể sao chép liên kết. Vui lòng sao chép thủ công.', true); // Show error
                }
                document.body.removeChild(textArea);
            } else {
                showTemporaryMessage('Không có liên kết nào để sao chép.', true);
            }
        });

        // Event listener for the "Summarize Video" button
        summarizeVideoBtn.addEventListener('click', () => {
            if (links.length > 0) {
                summarySection.classList.remove('hidden');
                summaryOutput.textContent = ''; // Clear previous summary
                copySummaryBtn.classList.add('hidden'); // Hide copy summary button initially
                // Pre-fill with a more generic prompt for better initial experience
                summaryPromptInput.value = `Tóm tắt video YouTube này: ${links[0]}.`;
                summaryPromptInput.focus(); // Focus on the prompt input
            } else {
                showTemporaryMessage('Không có liên kết nào để tóm tắt.', true);
                summarySection.classList.add('hidden');
            }
        });

        // Event listeners for prompt suggestion buttons
        promptSuggestionButtons.forEach(button => {
            button.addEventListener('click', () => {
                const currentLink = links.length > 0 ? links[0] : '';
                let suggestion = button.textContent.trim();
                if (suggestion === 'Tóm tắt ngắn') {
                    summaryPromptInput.value = `Tóm tắt ngắn gọn video YouTube này: ${currentLink}.`;
                } else if (suggestion === 'Các điểm chính') {
                    summaryPromptInput.value = `Liệt kê các điểm chính của video YouTube này: ${currentLink}.`;
                } else if (suggestion === 'Tạo FAQ') {
                    summaryPromptInput.value = `Tạo 3 câu hỏi thường gặp (FAQ) và câu trả lời ngắn gọn dựa trên nội dung video YouTube này: ${currentLink}.`;
                } else if (suggestion === 'Viết mô tả video') {
                    summaryPromptInput.value = `Viết một đoạn mô tả video YouTube này (khoảng 150 ký tự) kèm theo các từ khóa liên quan: ${currentLink}.`;
                }
                summaryPromptInput.focus();
            });
        });


        // Event listener for the "Generate Summary" button
        generateSummaryBtn.addEventListener('click', async () => {
            const prompt = summaryPromptInput.value.trim();
            if (!prompt) {
                showTemporaryMessage('Vui lòng nhập yêu cầu tóm tắt.', true);
                return;
            }

            summaryOutput.textContent = ''; // Clear previous output
            summaryLoader.classList.remove('hidden'); // Show loader
            generateSummaryBtn.disabled = true; // Disable button during processing
            copyLinkBtn.disabled = true; // Temporarily disable copy button during LLM call
            copySummaryBtn.classList.add('hidden'); // Hide copy summary button during generation

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    summaryOutput.textContent = text;
                    showTemporaryMessage('Tóm tắt đã được tạo thành công!');
                    copySummaryBtn.classList.remove('hidden'); // Show copy summary button
                } else {
                    summaryOutput.textContent = 'Không thể tạo tóm tắt. Cấu trúc phản hồi không mong muốn.';
                    showTemporaryMessage('Lỗi khi tạo tóm tắt.', true);
                }
            } catch (error) {
                console.error('Lỗi khi gọi API Gemini:', error);
                summaryOutput.textContent = 'Đã xảy ra lỗi khi kết nối với AI. Vui lòng kiểm tra kết nối mạng và thử lại.';
                showTemporaryMessage('Lỗi kết nối AI.', true);
            } finally {
                summaryLoader.classList.add('hidden'); // Hide loader
                generateSummaryBtn.disabled = false; // Enable button
                if (links.length > 0) { // Only re-enable if there are still links
                    copyLinkBtn.disabled = false; 
                }
            }
        });

        // Event listener for the "Copy Summary" button
        copySummaryBtn.addEventListener('click', () => {
            const summaryText = summaryOutput.textContent;
            if (summaryText) {
                const textArea = document.createElement('textarea');
                textArea.value = summaryText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showTemporaryMessage('Đã sao chép tóm tắt vào khay nhớ tạm!');

                    // Visual feedback on button
                    copySummaryButtonText.textContent = 'Đã Sao Chép!';
                    copySummaryBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    copySummaryBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');

                    if (copySummaryButtonTimeout) {
                        clearTimeout(copySummaryButtonTimeout);
                    }
                    copySummaryButtonTimeout = setTimeout(() => {
                        copySummaryButtonText.textContent = 'Sao chép Tóm tắt';
                        copySummaryBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        copySummaryBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    }, 1500); // Revert after 1.5 seconds

                } catch (err) {
                    console.error('Không thể sao chép tóm tắt: ', err);
                    showTemporaryMessage('Không thể sao chép tóm tắt. Vui lòng sao chép thủ công.', true);
                }
                document.body.removeChild(textArea);
            } else {
                showTemporaryMessage('Không có tóm tắt nào để sao chép.', true);
            }
        });

        // Event listener for the "Close Summary" button
        closeSummaryBtn.addEventListener('click', () => {
            summarySection.classList.add('hidden');
            summaryOutput.textContent = ''; // Clear output when closing
            summaryPromptInput.value = ''; // Clear prompt input
            copySummaryBtn.classList.add('hidden'); // Hide copy summary button
        });

        // Initial display state and count update on page load
        updateInitialLinkCount(); // Call on load to show initial count (0)
    </script>
</body>
</html>
