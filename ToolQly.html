<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Qu·∫£n l√Ω S·ª± ki·ªán ƒêa nƒÉng</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; background-color: #111827; }
        .form-input, .form-textarea, .form-select {
            background-color: #374151; border-color: #4B5563; color: #F9FAFB;
            border-radius: 0.5rem; padding: 0.75rem 1rem; width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none; border-color: #3B82F6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn {
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;
            text-align: center; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background-color: #2563EB; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1D4ED8; }
        .btn-secondary { background-color: #4B5563; color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #6B7280; }
        .btn-delete { background-color: #EF4444; color: white; }
        .btn-delete:hover:not(:disabled) { background-color: #DC2626; }
        .btn-save { background-color: #F59E0B; color: white; }
        .btn-save:hover { background-color: #D97706; }
        .btn-export { background-color: #10B981; color: white; }
        .btn-export:hover:not(:disabled) { background-color: #059669; }

        .report-table th, .report-table td {
            border: 1px solid #4B5563; text-align: center; vertical-align: middle;
            padding: 0.75rem 0.5rem; white-space: normal; word-break: break-word;
            position: relative; /* For input positioning */
        }
        /* Style for inline editing input */
        .report-table td input.inline-edit-input {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
            border: 2px solid #3B82F6;
            background-color: #1F2937; color: #F9FAFB;
            padding: 0.75rem 0.5rem; box-sizing: border-box;
            border-radius: 0; /* Match cell shape */
        }

        .report-body > tr, .report-header-row > th[data-reg-id] { cursor: pointer; }
        .report-body > tr.editing-in-form, .report-header-row > th.editing-in-form { background-color: #3B82F6 !important; color: white; }
        .report-body > tr.editing-in-form:hover, .report-header-row > th.editing-in-form:hover { background-color: #2563EB !important; }
        
        #toast-container { position: fixed; top: 1.25rem; right: 1.25rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast {
            background-color: #2d3748; color: #e2e8f0; border-left: 4px solid;
            padding: 1rem; border-radius: 0.375rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            display: flex; align-items: center; opacity: 0;
            transform: translateX(100%); transition: all 0.4s ease-in-out;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-color: #38a169; }
        .toast.error { border-color: #e53e3e; }
        .toast.info { border-color: #3b82f6; }

        .manage-cols-item, .manage-sections-item { cursor: grab; }
        .sortable-ghost { opacity: 0.4; background: #374151; }
        .sortable-chosen { background-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); cursor: grabbing; }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        
        [data-tooltip] { position: relative; }
        [data-tooltip]::after {
            content: attr(data-tooltip); position: absolute; bottom: 110%; left: 50%;
            transform: translateX(-50%); background-color: #1f2937; color: #f9fafb;
            padding: 6px 12px; border-radius: 6px; font-size: 12px;
            white-space: nowrap; opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
            z-index: 10000; border: 1px solid #4B5563;
        }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-8px); }

        #loading-overlay { position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 0.3s; }
        
        /* Mobile Tab Navigation */
        #mobile-nav {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .mobile-tab.active {
            color: #3B82F6;
            border-top-color: #3B82F6;
        }

        /* Styles for printable report container (off-screen but rendered) */
        #printable-report {
            position: absolute;
            left: -9999px; /* Move off-screen */
            top: -9999px;
            width: 100%; /* Ensure it takes full width for capture */
            box-sizing: border-box; /* Include padding in width */
            background-color: white; /* Ensure white background for print */
            color: black; /* Ensure black text for print */
            z-index: -1; /* Keep it behind everything else */
            padding: 20px; /* Add some default padding */
        }
        #printable-report.visible-for-capture {
            position: static; /* Bring it back to normal flow for capture */
            left: 0;
            top: 0;
            z-index: 9998; /* Bring it above other content temporarily */
            background-color: white; /* Ensure white background */
            color: black; /* Ensure black text */
            display: block !important; /* Override hidden */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div id="loading-overlay" class="hidden"><div id="loading-text" class="text-white text-lg">ƒêang x·ª≠ l√Ω...</div></div>
    <div id="toast-container"></div>
    <div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div id="datalists-container"></div>

    <div class="max-w-screen-2xl mx-auto p-4 sm:p-6 md:p-8">
        <header class="mb-6 flex items-stretch justify-between gap-4">
            <div class="flex-shrink-0 w-16 md:w-20 flex items-center justify-center">
                <img src="https://thiensutinhquang.github.io/Admin/icons/icon-192.png" alt="App Logo" class="h-full w-auto object-contain">
            </div>
            <div class="flex-grow text-center py-2">
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-white">Tool Qu·∫£n l√Ω S·ª± ki·ªán ƒêa nƒÉng</h1>
                    <p class="text-xl sm:text-2xl text-yellow-400 font-semibold mt-1">Gia ƒë√¨nh Minh S∆∞ T·ªãnh Quang</p>
            </div>
            <div class="flex-shrink-0 w-16 md:w-20"></div> <!-- Spacer to balance the logo -->
        </header>

        <section class="bg-gray-800 p-4 rounded-xl shadow-lg mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-grow w-full md:w-auto">
                    <label for="eventSelector" class="block mb-2 text-sm text-white font-medium">üéØ Ch·ªçn s·ª± ki·ªán ƒë√£ t·∫°o:</label>
                    <div class="flex gap-2 items-center">
                        <select id="eventSelector" class="form-select w-full max-w-md">
                          <option disabled selected>ƒêang t·∫£i danh s√°ch s·ª± ki·ªán...</option>
                        </select>
                        <button id="deleteSelectedEventBtn" class="btn btn-delete text-sm" data-tooltip="Xo√° s·ª± ki·ªán ƒë√£ ch·ªçn">üóëÔ∏è Xo√°</button>
                      </div>
                </div>
                <div id="main-actions-container" class="flex flex-col sm:flex-row flex-wrap gap-2 justify-center">
                    <button id="exportBtn" class="btn btn-export w-full sm:w-auto" data-tooltip="Xu·∫•t b√°o c√°o ra c√°c ƒë·ªãnh d·∫°ng kh√°c nhau">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-2" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                        Xu·∫•t file
                    </button>
                    <button id="geminiSuggestBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white w-full sm:w-auto" data-tooltip="D√πng AI ƒë·ªÉ g·ª£i √Ω c√°c m·ª•c ƒëƒÉng k√Ω d·ª±a tr√™n ch·ªß ƒë·ªÅ s·ª± ki·ªán">‚ú® G·ª£i √Ω m·ª•c</button>
                    <button id="manageSectionsBtn" class="btn btn-secondary w-full sm:w-auto" data-tooltip="Qu·∫£n l√Ω c√°c m·ª•c b√°o c√°o">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="mr-1"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3z"/></svg>
                        Qu·∫£n l√Ω M·ª•c
                    </button>
                    <button id="newListBtn" class="btn btn-primary w-full sm:w-auto" data-tooltip="T·∫°o m·ªôt s·ª± ki·ªán m·ªõi">T·∫°o s·ª± ki·ªán m·ªõi</button>
                    <button id="renameListBtn" class="btn btn-secondary w-full sm:w-auto" data-tooltip="ƒê·ªïi t√™n s·ª± ki·ªán hi·ªán t·∫°i">ƒê·ªïi t√™n</button>
                    <button id="shareListBtn" class="btn btn-save w-full sm:w-auto" data-tooltip="Chia s·∫ª s·ª± ki·ªán n√†y ƒë·ªÉ c·ªông t√°c">Chia s·∫ª</button>
                </div>
            </div>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Panel Nh·∫≠p li·ªáu -->
            <div id="form-panel" class="bg-gray-800 p-6 rounded-xl shadow-lg lg:col-span-2 self-start lg:sticky top-8 hidden lg:block">
                <h2 id="form-title" class="text-xl font-semibold mb-6 border-b border-gray-700 pb-4 text-center"></h2>
                <form id="registrationForm" class="space-y-4"></form>
                    <div id="form-actions" class="pt-5 space-y-3 border-t border-gray-700 mt-5">
                    <button type="button" id="submitBtn" class="btn btn-primary btn-lg w-full shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-150">Th√™m v√†o B√°o c√°o</button>
                    <div id="edit-actions" class="hidden grid grid-cols-2 gap-3">
                            <button type="button" id="deleteFromFormBtn" class="btn btn-delete w-full" data-tooltip="Xo√° m·ª•c ƒëang ƒë∆∞·ª£c ch·ªçn">Xo√° m·ª•c</button>
                            <button type="button" id="cancelEditBtn" class="btn btn-secondary w-full" data-tooltip="Hu·ª∑ ch·ªânh s·ª≠a v√† quay l·∫°i ch·∫ø ƒë·ªô th√™m m·ªõi">Hu·ª∑ b·ªè</button>
                    </div>
                </div>
            </div>

            <!-- C·ªôt n·ªôi dung ch√≠nh (B√°o c√°o & Th·ªëng k√™) -->
            <div id="right-column" class="lg:col-span-3 flex flex-col gap-8">
                <!-- Container for all report sections -->
                <div id="sections-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- C√°c m·ª•c b√°o c√°o s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
                </div>
                
                <!-- Panel Th·ªëng k√™ -->
                <div id="stats-panel" class="bg-gray-800 p-6 rounded-xl shadow-lg flex-col flex">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="chartTitle" class="text-xl font-semibold"></h3>
                            <div class="flex items-center gap-2">
                             <label for="chartColumnSelector" class="text-sm">Th·ªëng k√™ theo:</label>
                             <select id="chartColumnSelector" class="form-select text-sm py-1 px-2 w-40"></select>
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg h-80"><canvas id="provinceChart"></canvas></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Mobile Tab Navigation -->
    <nav id="mobile-nav" class="lg:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 flex justify-around">
        <button data-view="form-panel" class="mobile-tab flex-1 py-3 text-center text-gray-400 border-t-2 border-transparent">Nh·∫≠p li·ªáu</button>
        <button data-view="sections-container" class="mobile-tab flex-1 py-3 text-center text-gray-400 border-t-2 border-transparent active">B√°o c√°o</button>
        <button data-view="stats-panel" class="mobile-tab flex-1 py-3 text-center text-gray-400 border-t-2 border-transparent">Th·ªëng k√™</button>
    </nav>


    <!-- Modals -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[60] hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 id="modalTitle" class="text-xl font-bold text-white mb-4"></h3>
            <p id="modalMessage" class="text-gray-300 mb-6 whitespace-pre-wrap"></p>
            <div id="modal-input-wrapper" class="mb-4 hidden"><input type="text" id="modalInput" class="form-input"></div>
            <div class="flex justify-end gap-4">
                <button id="cancelBtn" class="btn btn-secondary">Hu·ª∑</button>
                <button id="confirmBtn" class="btn btn-delete">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
    
    <div id="manageSectionsModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold text-white mb-6">Qu·∫£n l√Ω c√°c M·ª•c B√°o c√°o</h3>
            <div id="manageSectionsForm" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
            <button id="addNewSectionBtn" class="btn btn-primary w-full mt-4">Th√™m M·ª•c M·ªõi</button>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancelManageSectionsBtn" type="button" class="btn btn-secondary">ƒê√≥ng</button>
                <button id="saveManageSectionsBtn" type="button" class="btn btn-save">L∆∞u & C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>
    
    <div id="manageColsModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <h3 id="manageColsModalTitle" class="text-xl font-bold text-white mb-6">Qu·∫£n l√Ω C·ªôt/D√≤ng</h3>
            <div id="manageColsForm" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
            <button id="addNewColBtn" class="btn btn-primary w-full mt-4">Th√™m C·ªôt/D√≤ng M·ªõi</button>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancelManageColsBtn" type="button" class="btn btn-secondary">ƒê√≥ng</button>
                <button id="saveManageColsBtn" type="button" class="btn btn-save">L∆∞u & C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>

    <div id="exportOptionsModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 id="exportModalTitle" class="text-xl font-bold text-white mb-6">Tu·ª≥ ch·ªçn Xu·∫•t file</h3>
             <div class="space-y-4">
                <div>
                    <label for="signerNameInput" class="block mb-2 text-sm text-gray-300">T√™n Ng∆∞·ªùi k√Ω (Tu·ª≥ ch·ªçn)</label>
                    <input type="text" id="signerNameInput" class="form-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
                </div>
                <div>
                    <label for="logoUploader" class="block mb-2 text-sm text-gray-300">Th√™m Logo (Tu·ª≥ ch·ªçn)</label>
                    <p class="text-xs text-gray-400 mb-2">N·∫øu kh√¥ng ch·ªçn, logo m·∫∑c ƒë·ªãnh c·ªßa T·ªãnh Quang s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.</p>
                    <input type="file" id="logoUploader" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <img id="logoPreview" src="" alt="Logo Preview" class="max-h-20 mx-auto hidden rounded">
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-4 border-t border-gray-700">
                <button id="exportJpgBtn" type="button" class="btn btn-primary w-full">JPG</button>
                <button id="exportPdfBtn" type="button" class="btn btn-primary w-full">PDF</button>
                <button id="exportXlsxBtn" type="button" class="btn btn-primary w-full">Excel</button>
                <button id="exportTxtBtn" type="button" class="btn btn-primary w-full">TXT</button>
            </div>
            <div class="flex justify-end mt-4">
                <button id="cancelExportBtn" type="button" class="btn btn-secondary">Hu·ª∑</button>
            </div>
        </div>
    </div>
    
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold text-white mb-4">Chia s·∫ª S·ª± ki·ªán</h3>
            <p class="text-gray-400 mb-4">G·ª≠i li√™n k·∫øt n√†y cho ng∆∞·ªùi kh√°c ƒë·ªÉ h·ªç c√≥ th·ªÉ xem v√† ch·ªânh s·ª≠a c√πng b·∫°n.</p>
            <div class="flex items-center gap-2">
                <input type="text" id="shareLinkInput" readonly class="form-input bg-gray-900">
                <button id="copyShareLinkBtn" class="btn btn-primary" data-tooltip="Sao ch√©p li√™n k·∫øt">
                       <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>
            </div>
             <div class="flex justify-end gap-4 mt-6">
                <button id="closeShareModalBtn" type="button" class="btn btn-secondary">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Gemini AI Suggestion Modal -->
    <div id="geminiSuggestModal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl mx-4 flex flex-col">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">‚ú® Tr·ª£ l√Ω S√°ng t·∫°o AI</h3>
            <div class="mb-4">
                <label for="geminiSectionSelector" class="block mb-2 text-sm text-gray-300">Ch·ªçn m·ª•c ƒë·ªÉ th√™m g·ª£i √Ω:</label>
                <select id="geminiSectionSelector" class="form-select"></select>
            </div>
            <p class="text-gray-400 mb-4">M√¥ t·∫£ ch·ªß ƒë·ªÅ s·ª± ki·ªán, AI s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√†o c√°c c·ªôt t∆∞∆°ng ·ª©ng trong b·∫£ng c·ªßa b·∫°n.</p>
            <textarea id="geminiPrompt" class="form-textarea w-full" rows="3" placeholder="V√≠ d·ª•: VƒÉn ngh·ªá m·ª´ng l·ªÖ Vu Lan b√°o hi·∫øu..."></textarea>
            <div class="flex gap-4 mt-4">
                <button id="getGeminiSuggestionsBtn" class="btn btn-primary w-full">T·∫°o g·ª£i √Ω</button>
                <button id="resetGeminiSuggestionsBtn" class="btn btn-secondary w-full hidden">T·∫°o l·∫°i t·ª´ ƒë·∫ßu</button>
            </div>
            <div id="gemini-loading" class="text-center my-4 hidden">
                <p class="text-purple-400">AI ƒëang suy nghƒ©, vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mt-2"></div>
            </div>
            <div id="geminiSuggestionsContainer" class="mt-6 max-h-64 overflow-y-auto space-y-3 pr-2"></div>
            <div class="flex justify-end gap-4 mt-6 border-t border-gray-700 pt-4">
                <button id="cancelGeminiSuggestBtn" type="button" class="btn btn-secondary">ƒê√≥ng</button>
                <button id="addSuggestionsBtn" type="button" class="btn btn-save hidden">Th√™m c√°c m·ª•c ƒë√£ ch·ªçn</button>
            </div>
        </div>
    </div>

    <!-- Hidden container for printing/exporting -->
    <div id="printable-report" class="hidden"></div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";

        const { jsPDF } = window.jspdf;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBVAwc637Ql73tmvCe0VjXccg9Zg5KtT_g",
            authDomain: "noidungdanang.firebaseapp.com",
            projectId: "noidungdanang",
            storageBucket: "noidungdanang.appspot.com",
            messagingSenderId: "661993196911",
            appId: "1:661993196911:web:1dd44289d187bd5ec3ac9a",
            measurementId: "G-C9HM7PZKTD"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const analytics = getAnalytics(app);
        
        // Default columns for new sections
        const DEFAULT_COLUMNS = [
            { id: 'col_name', label: "T√™n" }, 
            { id: 'col_province', label: "T·ªânh" }, 
            { id: 'col_category', label: "Th·ªÉ lo·∫°i" },
            { id: 'col_content', label: "N·ªôi dung" }, 
            { id: 'col_notes', label: "Ghi ch√∫" }
        ];

        // --- GLOBAL APP STATE ---
        let currentEventId = null;
        let eventData = null;
        let unsubscribeFromEvent = null;
        let unsubscribeFromEventList = null;
        let user = null;

        // --- DOM Elements ---
        let registrationForm, sectionsContainer, formTitle, submitBtn, editActionsContainer,
            chartTitle, chartColumnSelector, provinceChartCanvas,
            manageSectionsModal, manageColsModal, exportOptionsModal,
            shareModal, shareLinkInput, copyShareLinkBtn, closeShareModalBtn,
            eventSelector, deleteSelectedEventBtn, newListBtn, renameListBtn, shareListBtn,
            geminiSuggestModal, geminiSuggestBtn, getGeminiSuggestionsBtn, resetGeminiSuggestionsBtn, geminiPrompt, 
            geminiSuggestionsContainer, geminiLoading, cancelGeminiSuggestBtn, addSuggestionsBtn, geminiSectionSelector,
            cancelEditBtn, deleteFromFormBtn, exportBtn;

        // Local State
        let provinceChart = null;
        let confirmAction = null;
        let currentlyEditingId = null;
        let activeSectionId = null;
        let activeSectionIdForCols = null;
        let uploadedLogo = null;
        let tempSections = [];
        let tempColumns = [];
        let sortableSectionsInstance = null;
        let sortableColsInstance = null;
        
        // --- UTILS ---
        const capitalizeFirst = str => !str ? '' : str.charAt(0).toUpperCase() + str.slice(1);

        const showToast = (message, type = 'success', announce = true) => {
            const container = document.getElementById('toast-container');
            if(!container) return;
            const toast = Object.assign(document.createElement('div'), {
                className: `toast ${type}`, textContent: message
            });
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
            if (announce) {
                const announcer = document.getElementById('sr-announcer');
                if (announcer) announcer.textContent = message;
            }
        };

        const showConfirmModal = (title, message, options = {}) => {
            const modal = document.getElementById('confirmModal');
            if(!modal) return;
            modal.querySelector('#modalTitle').textContent = title;
            modal.querySelector('#modalMessage').textContent = message;
            const inputWrapper = modal.querySelector('#modal-input-wrapper');
            inputWrapper.classList.toggle('hidden', !options.showInput);
            if (options.showInput) {
                const input = modal.querySelector('#modalInput');
                input.value = options.defaultValue || '';
                input.focus();
            }
            confirmAction = options.action;
            modal.classList.remove('hidden');
        };

        const hideConfirmModal = () => {
            const modal = document.getElementById('confirmModal');
            if(modal) modal.classList.add('hidden');
        };

        // --- INLINE EDITING FUNCTIONS ---
        function makeCellEditable(cell) {
            if (cell.querySelector('input')) return;
            
            const originalValue = cell.textContent.trim();
            cell.innerHTML = '';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'inline-edit-input';
            input.value = originalValue;
            input.dataset.originalValue = originalValue;

            input.addEventListener('blur', saveInlineEdit);
            input.addEventListener('keydown', handleCellEditKeydown);

            cell.appendChild(input);
            input.focus();
            input.select();
        }

        function handleCellEditKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelInlineEdit(e.target);
            }
        }

        async function saveInlineEdit(e) {
            const input = e.target;
            const cell = input.parentElement;
            const newValue = input.value.trim();
            const originalValue = input.dataset.originalValue;
            
            revertCellToText(cell, newValue);

            if (newValue === originalValue) return;

            const { sectionId, regId, colId } = cell.dataset;

            const sectionIndex = eventData.sections.findIndex(s => s.id === sectionId);
            if (sectionIndex === -1) return;

            const regIndex = eventData.sections[sectionIndex].registrations.findIndex(r => r.id === regId);
            if (regIndex === -1) return;

            eventData.sections[sectionIndex].registrations[regIndex].values[colId] = newValue;
            
            try {
                await updateEvent({ sections: eventData.sections });
                showToast('ƒê√£ c·∫≠p nh·∫≠t!', 'success', false);
            } catch (error) {
                console.error("Error saving inline edit:", error);
                showToast('L·ªói khi l∆∞u.', 'error');
                eventData.sections[sectionIndex].registrations[regIndex].values[colId] = originalValue;
                cell.textContent = originalValue; 
            }
        }

        function cancelInlineEdit(input) {
            const cell = input.parentElement;
            const originalValue = input.dataset.originalValue;
            revertCellToText(cell, originalValue);
        }

        function revertCellToText(cell, text) {
            cell.innerHTML = text;
            cell.style.whiteSpace = 'pre-wrap';
        }


        // --- DYNAMIC UI RENDERING ---
        const renderUI = () => {
            if (!eventData || !eventSelector) return;
            if (eventSelector) eventSelector.value = currentEventId;

            const formPanel = document.getElementById('form-panel');
            const rightColumn = document.getElementById('right-column');
            const sectionsContainer = document.getElementById('sections-container');
            const statsPanel = document.getElementById('stats-panel');

            // This logic should only apply to desktop views
            if (window.innerWidth >= 1024) { 
                const sectionCount = eventData.sections ? eventData.sections.length : 0;

                if (sectionCount > 1) {
                    // Multiple sections: 2-column layout
                    formPanel.classList.remove('hidden');
                    statsPanel.classList.remove('hidden');
                    
                    rightColumn.classList.remove('lg:col-span-5');
                    rightColumn.classList.add('lg:col-span-3');
                    
                    sectionsContainer.classList.remove('grid-cols-1');
                    sectionsContainer.classList.add('md:grid-cols-2');
                } else {
                    // Single section (or zero): 1-column layout
                    formPanel.classList.add('hidden');
                    statsPanel.classList.add('hidden');
                    
                    rightColumn.classList.remove('lg:col-span-3');
                    rightColumn.classList.add('lg:col-span-5');

                    sectionsContainer.classList.remove('md:grid-cols-2');
                    sectionsContainer.classList.add('grid-cols-1');
                }
            }

            renderSections();
            updateChart();
        };

        const renderSections = () => {
            if (!eventData || !eventData.sections) {
                sectionsContainer.innerHTML = '';
                return;
            }
            sectionsContainer.innerHTML = '';
            
            eventData.sections.forEach(section => {
                const itemTypeForButton = section.isTransposed ? 'C·ªôt' : 'H√†ng';
                const sectionEl = document.createElement('div');
                sectionEl.id = `section-${section.id}`;
                sectionEl.className = 'bg-gray-800 rounded-xl shadow-lg flex flex-col';
                
                sectionEl.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 p-3 bg-gray-700 rounded-t-xl">
                        <h2 class="text-xl font-semibold text-yellow-300">${section.title}</h2>
                        <div class="flex items-center gap-2 flex-wrap">
                            <button class="btn btn-primary text-xs p-2 add-item-btn" data-section-id="${section.id}" data-tooltip="Th√™m ${itemTypeForButton} n·ªôi dung m·ªõi">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle mr-1" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                                Th√™m ${itemTypeForButton}
                            </button>
                            <button class="btn btn-secondary text-xs p-2 manage-cols-btn" data-section-id="${section.id}" data-tooltip="Qu·∫£n l√Ω C·ªôt/D√≤ng cho m·ª•c n√†y">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                                C·ªôt/D√≤ng
                            </button>
                            <button class="btn btn-secondary text-xs p-2 transpose-btn" data-section-id="${section.id}" data-tooltip="Ho√°n ƒë·ªïi c√°ch hi·ªÉn th·ªã gi·ªØa C·ªôt v√† D√≤ng">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="8 21 3 21 3 16"></polyline><line x1="15" y1="15" x2="3" y2="3"></line></svg>
                                Ho√°n ƒë·ªïi
                            </button>
                        </div>
                    </div>
                    <div class="p-4 flex-grow flex flex-col">
                        <p class="text-gray-400 mb-4">T·ªïng s·ªë m·ª•c: <span class="font-bold text-white participant-counter">${(section.registrations || []).length}</span>. M·∫πo: Nh√°y ƒë√∫p v√†o √¥ ƒë·ªÉ s·ª≠a nhanh.</p>
                        <div class="overflow-x-auto flex-grow">
                            <table class="w-full text-sm text-gray-300 border-collapse report-table">
                                <thead class="text-xs text-gray-300 uppercase bg-gray-600 sticky top-0">
                                    <tr class="report-header-row"></tr>
                                </thead>
                                <tbody class="report-body bg-gray-800"></tbody>
                            </table>
                        </div>
                    </div>
                `;
                sectionsContainer.appendChild(sectionEl);
                renderTableForSection(section);
            });
        };

        const renderTableForSection = (section) => {
            const sectionEl = document.getElementById(`section-${section.id}`);
            if (!sectionEl) return;

            const reportHeaderRow = sectionEl.querySelector('.report-header-row');
            const reportBody = sectionEl.querySelector('.report-body');

            reportHeaderRow.innerHTML = '';
            reportBody.innerHTML = '';

            const { registrations, columns, isTransposed } = section;
            const registrationArray = registrations || [];

            if (isTransposed) {
                let headerHtml = '<th>M·ª•c</th>';
                registrationArray.forEach((reg, index) => {
                    const isEditing = reg.id === currentlyEditingId && section.id === activeSectionId;
                    headerHtml += `<th data-reg-id="${reg.id}" data-section-id="${section.id}" class="hover:bg-gray-600 p-2 ${isEditing ? 'editing-in-form' : ''}">${index + 1}</th>`;
                });
                reportHeaderRow.innerHTML = headerHtml;

                let bodyHtml = '';
                columns.forEach(col => {
                    bodyHtml += `<tr><td class="font-semibold bg-gray-700/50 text-left p-2">${col.label}</td>`;
                    registrationArray.forEach(reg => {
                        bodyHtml += `<td data-col-id="${col.id}" data-section-id="${section.id}" data-reg-id="${reg.id}">${reg.values[col.id] || ''}</td>`;
                    });
                    bodyHtml += `</tr>`;
                });

                bodyHtml += `<tr><td class="font-semibold bg-gray-700/50 text-left p-2">H√†nh ƒë·ªông</td>`;
                registrationArray.forEach(reg => {
                    bodyHtml += `<td><button class="btn btn-delete text-xs" data-id="${reg.id}" data-section-id="${section.id}" data-tooltip="Xo√° m·ª•c n√†y">Xo√°</button></td>`;
                });
                bodyHtml += `</tr>`;
                reportBody.innerHTML = bodyHtml;

            } else {
                reportHeaderRow.innerHTML = `<th>STT</th>` + columns.map(c => `<th>${c.label}</th>`).join('') + `<th>H√†nh ƒë·ªông</th>`;
                const fragment = document.createDocumentFragment();
                if (registrationArray.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="${columns.length + 2}" class="text-center p-4">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>`;
                    fragment.appendChild(tr);
                } else {
                    registrationArray.forEach((reg, index) => {
                        const tr = document.createElement('tr');
                        tr.className = `hover:bg-gray-700/50 transition-colors duration-150 ${reg.id === currentlyEditingId && section.id === activeSectionId ? 'editing-in-form' : ''}`;
                        tr.dataset.regId = reg.id;
                        tr.dataset.sectionId = section.id;
                        tr.innerHTML = `
                            <td class="font-medium">${index + 1}</td>
                            ${columns.map(c => `<td data-col-id="${c.id}" data-section-id="${section.id}" data-reg-id="${reg.id}" style="white-space: pre-wrap;">${reg.values[c.id] || ''}</td>`).join('')}
                            <td><div class="flex items-center justify-center space-x-2"><button class="btn btn-delete text-xs" data-id="${reg.id}" data-section-id="${section.id}" data-tooltip="Xo√° m·ª•c n√†y">Xo√°</button></div></td>
                        `;
                        fragment.appendChild(tr);
                    });
                }
                reportBody.appendChild(fragment);
            }
        };

        const populateEventSelector = (events) => {
            if(!eventSelector) return;
            eventSelector.innerHTML = '';
            if (events.length === 0) {
                    eventSelector.add(new Option("Kh√¥ng c√≥ s·ª± ki·ªán n√†o, h√£y t·∫°o m·ªõi!", ""));
                    return;
            }
            events.sort((a,b) => b.createdAt - a.createdAt).forEach(event => {
                const option = new Option(event.name, event.id);
                eventSelector.add(option);
            });
            if(currentEventId) {
                eventSelector.value = currentEventId;
            }
        };

        const renderForm = (section) => {
            if(!section) {
                formTitle.textContent = "Ch·ªçn m·ªôt m·ª•c ƒë·ªÉ th√™m ho·∫∑c s·ª≠a";
                registrationForm.innerHTML = '<p class="text-gray-400 text-center">Nh·∫•n n√∫t "Th√™m H√†ng" ho·∫∑c "Th√™m C·ªôt" tr√™n m·ªôt b·∫£ng b√°o c√°o b·∫•t k·ª≥ ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>';
                document.getElementById('form-actions').classList.add('hidden');
                return;
            }
            document.getElementById('form-actions').classList.remove('hidden');
            const columns = section.columns || [];
            registrationForm.innerHTML = columns.map(col => `
                <div class="md:grid md:grid-cols-[120px,1fr] md:items-center md:gap-x-4">
                    <label for="form-field-${col.id}" class="block mb-1 text-sm text-gray-400 md:mb-0 md:text-right">${col.label}</label>
                    <input type="text" id="form-field-${col.id}" data-col-id="${col.id}" class="form-input" list="datalist-${col.id}">
                </div>
            `).join('');
        };

        const updateDatalists = () => { /* Placeholder */ };
        const updateChart = () => { /* Placeholder */ };
        
        // --- FORM MODE & ACTIONS ---
        function switchToEditMode(entry, section) {
            activeSectionId = section.id;
            currentlyEditingId = entry.id;
            
            const itemType = section.isTransposed ? 'c·ªôt' : 'h√†ng';
            formTitle.textContent = `Ch·ªânh s·ª≠a n·ªôi dung ${itemType} c·ªßa: ${section.title}`;
            formTitle.classList.add('text-yellow-400');
            
            renderForm(section);
            section.columns.forEach(col => {
                const input = registrationForm.querySelector(`[data-col-id="${col.id}"]`);
                if(input) input.value = entry.values[col.id] || '';
            });
            submitBtn.textContent = 'C·∫≠p nh·∫≠t';
            submitBtn.classList.replace('btn-primary', 'btn-save');
            editActionsContainer.classList.remove('hidden');
            renderUI();

            if (window.innerWidth < 1024) {
                document.getElementById('form-panel').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function switchToaddMode(section) {
            activeSectionId = section.id;
            currentlyEditingId = null;

            const itemType = section.isTransposed ? 'c·ªôt' : 'h√†ng';
            formTitle.textContent = `Th√™m n·ªôi dung cho ${itemType} c·ªßa: ${section.title}`;
            formTitle.classList.remove('text-yellow-400');
            
            renderForm(section);
            registrationForm.reset();
            submitBtn.textContent = 'Th√™m v√†o B√°o c√°o';
            submitBtn.classList.replace('btn-save', 'btn-primary');
            editActionsContainer.classList.add('hidden');
            renderUI();
        }

        // --- DATA MODIFICATION ---
        async function updateEvent(data) {
            if (!currentEventId) {
                showToast("Kh√¥ng c√≥ s·ª± ki·ªán n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ c·∫≠p nh·∫≠t.", "error");
                return;
            }
            try {
                const eventRef = doc(db, 'events', currentEventId);
                await updateDoc(eventRef, data);
            } catch (error) {
                console.error("Error updating event:", error);
                showToast("L·ªói khi c·∫≠p nh·∫≠t s·ª± ki·ªán.", "error");
            }
        }
        
        // --- DATA MIGRATION ---
        function migrateOldData(data) {
            if (data && !data.sections && (data.registrations || data.columns)) {
                return {
                    ...data,
                    sections: [{
                        id: `sec_${Date.now()}`,
                        title: "B√°o c√°o chi ti·∫øt",
                        columns: data.columns || JSON.parse(JSON.stringify(DEFAULT_COLUMNS)),
                        registrations: data.registrations || [],
                        isTransposed: false
                    }],
                    registrations: null,
                    columns: null
                };
            }
            return data;
        }

        // --- INITIALIZATION ---
        async function initializeAppLogic() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            return new Promise((resolve, reject) => {
                onAuthStateChanged(auth, async (userAuth) => {
                    if (userAuth) {
                        user = userAuth;
                        document.getElementById('loading-overlay').style.opacity = '0';
                        setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 300);
                        resolve(user);
                    } else {
                        try {
                           await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase Anonymous Sign-In Error:", error);
                            showToast("L·ªói k·∫øt n·ªëi x√°c th·ª±c. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Firebase c·ªßa b·∫°n v√† ƒë·∫£m b·∫£o ƒë√£ b·∫≠t ph∆∞∆°ng th·ª©c ƒëƒÉng nh·∫≠p '·∫®n danh' trong Firebase Console.", "error");
                            document.getElementById('loading-overlay').innerHTML = `<div class="text-white text-lg text-center p-4">L·ªói k·∫øt n·ªëi.<br>Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Firebase.</div>`;
                            reject(error);
                        }
                    }
                });
            });
        }

        async function loadEventFromUrl() {
            const eventId = window.location.hash.substring(1);
            if (eventId) {
                await loadEvent(eventId);
            } else {
                listenToUserEvents(true);
            }
        }
        
        async function loadEvent(eventId) {
            if (unsubscribeFromEvent) unsubscribeFromEvent();
            currentEventId = eventId;
            const eventRef = doc(db, 'events', eventId);
            
            unsubscribeFromEvent = onSnapshot(eventRef, (docSnap) => {
                if (docSnap.exists()) {
                    eventData = migrateOldData(docSnap.data());
                    if(eventData.sections && eventData.sections.length > 0 && !activeSectionId) {
                        activeSectionId = eventData.sections[0].id;
                        renderForm(eventData.sections[0]);
                    } else if (eventData.sections && eventData.sections.length > 0 && activeSectionId) {
                        const currentActiveSection = eventData.sections.find(s => s.id === activeSectionId);
                        if (currentActiveSection) {
                            renderForm(currentActiveSection);
                        } else {
                            activeSectionId = eventData.sections[0].id;
                            renderForm(eventData.sections[0]);
                        }
                    } else {
                        renderForm(null);
                    }
                    renderUI();
                } else {
                    showToast("S·ª± ki·ªán n√†y kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã xo√°.", "error");
                    window.location.hash = '';
                    eventData = null;
                    activeSectionId = null;
                    renderUI();
                    renderForm(null);
                }
            }, (error) => {
                    console.error("Error listening to event:", error);
                    showToast("L·ªói khi t·∫£i d·ªØ li·ªáu s·ª± ki·ªán.", "error");
            });
        }

        function listenToUserEvents(createIfNeeded = false) {
            if (unsubscribeFromEventList) unsubscribeFromEventList();
            const q = query(collection(db, "events")); 
            
            unsubscribeFromEventList = onSnapshot(q, (querySnapshot) => {
                const events = [];
                querySnapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });

                populateEventSelector(events);

                if (events.length === 0 && createIfNeeded) {
                    createNewOnlineEvent();
                } else if (!window.location.hash.substring(1) && events.length > 0) {
                    events.sort((a,b) => b.createdAt - a.createdAt);
                    window.location.hash = events[0].id;
                }
            }, (error) => {
                console.error("Error listening to event list:", error);
                showToast("L·ªói khi t·∫£i danh s√°ch s·ª± ki·ªán.", "error");
            });
        }

        async function createNewOnlineEvent() {
            if (!user) {
                showToast("Ch∆∞a th·ªÉ t·∫°o s·ª± ki·ªán. Vui l√≤ng ch·ªù x√°c th·ª±c.", "error");
                return;
            }
            const newEvent = {
                name: "S·ª± ki·ªán M·ªõi",
                createdAt: Date.now(),
                owner: user.uid,
                sections: [{
                    id: `sec_${Date.now()}`,
                    title: "B√°o c√°o chi ti·∫øt",
                    columns: JSON.parse(JSON.stringify(DEFAULT_COLUMNS)),
                    registrations: [],
                    isTransposed: false
                }]
            };
            try {
                const docRef = await addDoc(collection(db, "events"), newEvent);
                showToast("ƒê√£ t·∫°o s·ª± ki·ªán online m·ªõi!", "success");
                window.location.hash = docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
                showToast("Kh√¥ng th·ªÉ t·∫°o s·ª± ki·ªán m·ªõi.", "error");
            }
        }
        
        // --- MODAL MANAGEMENT ---
        const openManageSectionsModal = () => {
            if (!eventData) return;
            tempSections = JSON.parse(JSON.stringify(eventData.sections));
            renderManageSectionsForm();
            manageSectionsModal.classList.remove('hidden');

            const formContainer = manageSectionsModal.querySelector('#manageSectionsForm');
            if (sortableSectionsInstance) sortableSectionsInstance.destroy();
            sortableSectionsInstance = new Sortable(formContainer, {
                animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
            });
        };

        const renderManageSectionsForm = () => {
            const formContainer = manageSectionsModal.querySelector('#manageSectionsForm');
            formContainer.innerHTML = tempSections.map(sec => `
                <div class="flex items-center gap-3 p-2 bg-gray-700 rounded-lg manage-sections-item" data-id="${sec.id}">
                    <svg class="w-5 h-5 text-gray-400 cursor-grab drag-handle flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zM4 9a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    <input type="text" value="${sec.title}" data-section-id="${sec.id}" class="form-input flex-grow text-sm py-1">
                    <button data-section-id="${sec.id}" class="btn btn-delete p-2 delete-section-btn" data-tooltip="Xo√° m·ª•c n√†y"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>`).join('');
        };
        
        const openManageColsModal = (sectionId) => {
            const section = eventData.sections.find(s => s.id === sectionId);
            if (!section) return;
            activeSectionIdForCols = sectionId;
            tempColumns = JSON.parse(JSON.stringify(section.columns));
            
            const modalTitleEl = manageColsModal.querySelector('#manageColsModalTitle');
            const addNewBtn = manageColsModal.querySelector('#addNewColBtn');
            if (section.isTransposed) {
                modalTitleEl.textContent = 'Qu·∫£n l√Ω D√≤ng';
                addNewBtn.textContent = 'Th√™m D√≤ng M·ªõi';
            } else {
                modalTitleEl.textContent = 'Qu·∫£n l√Ω C·ªôt';
                addNewBtn.textContent = 'Th√™m C·ªôt M·ªõi';
            }

            renderManageColsForm();
            manageColsModal.classList.remove('hidden');

            const formContainer = manageColsModal.querySelector('#manageColsForm');
            if (sortableColsInstance) sortableColsInstance.destroy();
            sortableColsInstance = new Sortable(formContainer, {
                animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
            });
        };

        const renderManageColsForm = () => {
            const formContainer = manageColsModal.querySelector('#manageColsForm');
            const section = eventData.sections.find(s => s.id === activeSectionIdForCols);
            const itemType = section && section.isTransposed ? 'd√≤ng' : 'c·ªôt';

            formContainer.innerHTML = tempColumns.map(col => `
                <div class="flex items-center gap-3 p-2 bg-gray-700 rounded-lg manage-cols-item" data-id="${col.id}">
                    <svg class="w-5 h-5 text-gray-400 cursor-grab drag-handle flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zM4 9a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    <input type="text" value="${col.label}" data-col-id="${col.id}" class="form-input flex-grow text-sm py-1">
                    <button data-col-id="${col.id}" class="btn btn-delete p-2 delete-col-btn" data-tooltip="Xo√° ${itemType} n√†y"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>`).join('');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Assign DOM elements
            registrationForm = document.getElementById('registrationForm');
            sectionsContainer = document.getElementById('sections-container');
            formTitle = document.getElementById('form-title');
            submitBtn = document.getElementById('submitBtn');
            editActionsContainer = document.getElementById('edit-actions');
            cancelEditBtn = document.getElementById('cancelEditBtn');
            deleteFromFormBtn = document.getElementById('deleteFromFormBtn');
            chartTitle = document.getElementById('chartTitle');
            chartColumnSelector = document.getElementById('chartColumnSelector');
            provinceChartCanvas = document.getElementById('provinceChart');
            manageSectionsModal = document.getElementById('manageSectionsModal');
            manageColsModal = document.getElementById('manageColsModal');
            exportOptionsModal = document.getElementById('exportOptionsModal');
            shareModal = document.getElementById('shareModal');
            shareLinkInput = document.getElementById('shareLinkInput');
            copyShareLinkBtn = document.getElementById('copyShareLinkBtn');
            closeShareModalBtn = document.getElementById('closeShareModalBtn');
            eventSelector = document.getElementById('eventSelector');
            deleteSelectedEventBtn = document.getElementById('deleteSelectedEventBtn');
            newListBtn = document.getElementById('newListBtn');
            renameListBtn = document.getElementById('renameListBtn');
            shareListBtn = document.getElementById('shareListBtn');
            exportBtn = document.getElementById('exportBtn');
            geminiSuggestBtn = document.getElementById('geminiSuggestBtn');
            getGeminiSuggestionsBtn = document.getElementById('getGeminiSuggestionsBtn');
            resetGeminiSuggestionsBtn = document.getElementById('resetGeminiSuggestionsBtn');
            geminiPrompt = document.getElementById('geminiPrompt');
            geminiSuggestionsContainer = document.getElementById('geminiSuggestionsContainer');
            geminiLoading = document.getElementById('gemini-loading');
            cancelGeminiSuggestBtn = document.getElementById('cancelGeminiSuggestBtn');
            addSuggestionsBtn = document.getElementById('addSuggestionsBtn');
            geminiSectionSelector = document.getElementById('geminiSectionSelector');

            try {
                await initializeAppLogic();
                if(user) {
                    listenToUserEvents();
                    await loadEventFromUrl();
                }

                setupInitialView();
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered'), err => console.log('SW failed', err));
                    });
                }
                
                eventSelector.addEventListener('change', () => {
                    if (eventSelector.value && eventSelector.value !== currentEventId) {
                        window.location.hash = eventSelector.value;
                    }
                });

                // --- DELEGATED EVENT LISTENERS FOR DYNAMIC CONTENT ---
                sectionsContainer.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    // Handle buttons inside section headers (Add, Manage, Transpose)
                    const headerButton = target.closest('.bg-gray-700 .btn');
                    if (headerButton) {
                        const sectionId = headerButton.dataset.sectionId;
                        if (headerButton.classList.contains('add-item-btn')) {
                            const section = eventData.sections.find(s => s.id === sectionId);
                            if(section) switchToaddMode(section);
                        } else if (headerButton.classList.contains('manage-cols-btn')) {
                            openManageColsModal(sectionId);
                        } else if (headerButton.classList.contains('transpose-btn')) {
                            const sectionIndex = eventData.sections.findIndex(s => s.id === sectionId);
                            if (sectionIndex > -1) {
                                const section = eventData.sections[sectionIndex];
                                section.isTransposed = !section.isTransposed;
                                showToast(section.isTransposed ? 'ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô xem d·∫°ng d√≤ng.' : 'ƒê√£ chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô xem d·∫°ng c·ªôt.', 'info');
                                updateEvent({ sections: eventData.sections });
                                if (activeSectionId === sectionId) switchToaddMode(section);
                            }
                        }
                        return;
                    }
                    
                    // Handle delete button inside a table
                    const deleteButton = target.closest('button.btn-delete');
                    if (deleteButton && deleteButton.closest('.report-table')) {
                        const regId = deleteButton.dataset.id;
                        const sectionId = deleteButton.dataset.sectionId;
                        const section = eventData.sections.find(s => s.id === sectionId);
                        if (!section) return;

                        const itemType = section.isTransposed ? 'c·ªôt' : 'h√†ng';
                        showConfirmModal(`X√°c nh·∫≠n Xo√°`, `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° ${itemType} n√†y kh√¥ng?`, {
                            action: async () => {
                                const sectionIndex = eventData.sections.findIndex(s => s.id === sectionId);
                                if (sectionIndex > -1) {
                                    eventData.sections[sectionIndex].registrations = eventData.sections[sectionIndex].registrations.filter(r => r.id !== regId);
                                    await updateEvent({ sections: eventData.sections });
                                    showToast('ƒê√£ xo√° th√†nh c√¥ng!', 'success');
                                    if (currentlyEditingId === regId) switchToaddMode(section);
                                }
                                hideConfirmModal();
                            }
                        });
                        return;
                    }

                    // Handle click on a row or transposed header for form editing
                    const editableRowOrHeader = target.closest('tr[data-reg-id], th[data-reg-id]');
                    if (editableRowOrHeader && !target.closest('button')) {
                        const sectionId = editableRowOrHeader.dataset.sectionId;
                        const regId = editableRowOrHeader.dataset.regId;
                        const section = eventData.sections.find(s => s.id === sectionId);
                        if (!section || !regId) return;

                        const registrationToEdit = section.registrations.find(r => r.id === regId);
                        if (registrationToEdit) {
                            if (currentlyEditingId === regId && activeSectionId === sectionId) return;
                            switchToEditMode(registrationToEdit, section);
                        }
                    }
                });

                sectionsContainer.addEventListener('dblclick', (e) => {
                    const cell = e.target.closest('td[data-col-id]');
                    if (cell) {
                        makeCellEditable(cell);
                    }
                });

                // --- STATIC BUTTON LISTENERS ---
                newListBtn.addEventListener('click', createNewOnlineEvent);
                renameListBtn.addEventListener('click', () => {
                    if (!currentEventId || !eventData) return showToast("Vui l√≤ng ch·ªçn m·ªôt s·ª± ki·ªán ƒë·ªÉ ƒë·ªïi t√™n.", "error");
                    showConfirmModal('ƒê·ªïi t√™n s·ª± ki·ªán', 'Nh·∫≠p t√™n m·ªõi cho s·ª± ki·ªán:', {
                        showInput: true, defaultValue: eventData.name,
                        action: async (newName) => {
                            if (newName && newName.trim() !== '') {
                                await updateEvent({ name: newName.trim() });
                                showToast('ƒê√£ ƒë·ªïi t√™n s·ª± ki·ªán!', 'success');
                                hideConfirmModal();
                            } else { showToast('T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.', 'error'); }
                        }
                    });
                });
                shareListBtn.addEventListener('click', () => {
                    if (!currentEventId) return showToast("Vui l√≤ng ch·ªçn m·ªôt s·ª± ki·ªán ƒë·ªÉ chia s·∫ª.", "error");
                    shareLinkInput.value = window.location.href;
                    shareModal.classList.remove('hidden');
                });
                exportBtn.addEventListener('click', () => {
                    if (!currentEventId) return showToast("Vui l√≤ng ch·ªçn m·ªôt s·ª± ki·ªán ƒë·ªÉ xu·∫•t file.", "error");
                    exportOptionsModal.classList.remove('hidden');
                });
                geminiSuggestBtn.addEventListener('click', () => {
                    if (!eventData || !eventData.sections || eventData.sections.length === 0) return showToast("Vui l√≤ng t·∫°o √≠t nh·∫•t m·ªôt m·ª•c b√°o c√°o tr∆∞·ªõc.", "error");
                    geminiSectionSelector.innerHTML = eventData.sections.map(s => `<option value="${s.id}">${s.title}</option>`).join('');
                    geminiSuggestModal.classList.remove('hidden');
                });
                deleteSelectedEventBtn.addEventListener('click', () => {
                    if (!currentEventId || !eventData) return showToast("Vui l√≤ng ch·ªçn m·ªôt s·ª± ki·ªán ƒë·ªÉ xo√°.", "error");
                    showConfirmModal('X√°c nh·∫≠n Xo√°', `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° vƒ©nh vi·ªÖn s·ª± ki·ªán "${eventData.name}"?`, {
                        action: async () => {
                            try {
                                await deleteDoc(doc(db, 'events', currentEventId));
                                showToast('ƒê√£ xo√° s·ª± ki·ªán.', 'success');
                                window.location.hash = '';
                                hideConfirmModal();
                            } catch (error) {
                                console.error("Error deleting event: ", error);
                                showToast('L·ªói khi xo√° s·ª± ki·ªán.', 'error');
                                hideConfirmModal();
                            }
                        }
                    });
                });
                
                submitBtn.addEventListener('click', async () => {
                    if (!activeSectionId) return showToast('Vui l√≤ng ch·ªçn m·ªôt m·ª•c ƒë·ªÉ th√™m n·ªôi dung v√†o.', 'error');
                    if (navigator.vibrate) navigator.vibrate(50);

                    const sectionIndex = eventData.sections.findIndex(s => s.id === activeSectionId);
                    if (sectionIndex === -1) return showToast('M·ª•c kh√¥ng t·ªìn t·∫°i.', 'error');

                    const section = eventData.sections[sectionIndex];
                    const values = {};
                    registrationForm.querySelectorAll('input').forEach(input => {
                        values[input.dataset.colId] = input.value;
                    });

                    if (currentlyEditingId) {
                        const regIndex = section.registrations.findIndex(r => r.id === currentlyEditingId);
                        if (regIndex > -1) section.registrations[regIndex].values = values;
                    } else {
                        const newRegistration = { id: `reg_${Date.now()}`, values: values };
                        if (!section.registrations) section.registrations = [];
                        section.registrations.push(newRegistration);
                    }

                    try {
                        await updateEvent({ sections: eventData.sections });
                        showToast(currentlyEditingId ? 'ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'ƒê√£ th√™m th√†nh c√¥ng!', 'success');
                        registrationForm.reset();
                        if (currentlyEditingId) switchToaddMode(section);
                    } catch (error) {
                        console.error("Error saving data:", error);
                        showToast('L·ªói khi l∆∞u d·ªØ li·ªáu.', 'error');
                    }
                });

                // --- OTHER LISTENERS (MODALS, ETC.) ---
                document.getElementById('confirmBtn').addEventListener('click', () => {
                    if (typeof confirmAction === 'function') {
                        const input = document.getElementById('modalInput');
                        const value = input.parentElement.classList.contains('hidden') ? true : input.value;
                        confirmAction(value);
                    }
                });
                document.getElementById('cancelBtn').addEventListener('click', hideConfirmModal);
                closeShareModalBtn.addEventListener('click', () => shareModal.classList.add('hidden'));
                copyShareLinkBtn.addEventListener('click', () => {
                    shareLinkInput.select(); 
                    document.execCommand('copy');
                    showToast('ƒê√£ sao ch√©p!', 'success');
                });
                
                document.getElementById('manageSectionsBtn').addEventListener('click', openManageSectionsModal);

                cancelEditBtn.addEventListener('click', () => {
                    if (activeSectionId) {
                        const section = eventData.sections.find(s => s.id === activeSectionId);
                        if (section) {
                            switchToaddMode(section);
                            showToast('ƒê√£ hu·ª∑ ch·ªânh s·ª≠a.', 'info');
                        }
                    }
                });

                deleteFromFormBtn.addEventListener('click', () => {
                    if (!currentlyEditingId || !activeSectionId) return;
                    const section = eventData.sections.find(s => s.id === activeSectionId);
                    if (!section) return;
                    const itemType = section.isTransposed ? 'c·ªôt' : 'h√†ng';
                    showConfirmModal(`X√°c nh·∫≠n Xo√°`, `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° ${itemType} n√†y kh√¥ng?`, {
                        action: async () => {
                            const sectionIndex = eventData.sections.findIndex(s => s.id === activeSectionId);
                            if (sectionIndex > -1) {
                                eventData.sections[sectionIndex].registrations = eventData.sections[sectionIndex].registrations.filter(r => r.id !== currentlyEditingId);
                                await updateEvent({ sections: eventData.sections });
                                showToast('ƒê√£ xo√° th√†nh c√¥ng!', 'success');
                                switchToaddMode(section);
                            }
                            hideConfirmModal();
                        }
                    });
                });

                manageSectionsModal.addEventListener('click', async e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    if (button.id === 'addNewSectionBtn') {
                        tempSections.push({ id: `sec_${Date.now()}`, title: `M·ª•c m·ªõi ${tempSections.length + 1}`, columns: JSON.parse(JSON.stringify(DEFAULT_COLUMNS)), registrations: [], isTransposed: false });
                        renderManageSectionsForm();
                    } else if (button.classList.contains('delete-section-btn')) {
                        if (tempSections.length <= 1) return showToast("Ph·∫£i c√≥ √≠t nh·∫•t m·ªôt m·ª•c.", "error");
                        tempSections = tempSections.filter(s => s.id !== button.dataset.sectionId);
                        renderManageSectionsForm();
                    } else if (button.id === 'saveManageSectionsBtn') {
                        const newOrderIds = sortableSectionsInstance.toArray();
                        const reorderedSections = newOrderIds.map(id => {
                            const originalSection = tempSections.find(s => s.id === id);
                            const input = manageSectionsModal.querySelector(`input[data-section-id="${id}"]`);
                            if (originalSection && input) originalSection.title = input.value.trim() || 'Kh√¥ng t√™n';
                            return originalSection;
                        }).filter(Boolean);
                        eventData.sections = reorderedSections;
                        await updateEvent({ sections: eventData.sections });
                        manageSectionsModal.classList.add('hidden');
                        showToast('ƒê√£ c·∫≠p nh·∫≠t c√°c m·ª•c!', 'success');
                    } else if (button.id === 'cancelManageSectionsBtn') {
                        manageSectionsModal.classList.add('hidden');
                    }
                });
                
                manageColsModal.addEventListener('click', async e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const section = eventData.sections.find(s => s.id === activeSectionIdForCols);
                    const itemType = section && section.isTransposed ? 'd√≤ng' : 'c·ªôt';

                    if (button.id === 'addNewColBtn') {
                        tempColumns.push({ id: `col_${Date.now()}`, label: `M·ª•c m·ªõi ${tempColumns.length + 1}` });
                        renderManageColsForm();
                    } else if (button.classList.contains('delete-col-btn')) {
                        if (tempColumns.length <= 1) return showToast(`Ph·∫£i c√≥ √≠t nh·∫•t m·ªôt ${itemType}.`, "error");
                        tempColumns = tempColumns.filter(c => c.id !== button.dataset.colId);
                        renderManageColsForm();
                    } else if (button.id === 'saveManageColsBtn') {
                        const newOrderIds = [...manageColsModal.querySelectorAll('.manage-cols-item')].map(item => item.dataset.id);
                        const reorderedCols = newOrderIds.map(id => {
                            const originalCol = tempColumns.find(c => c.id === id);
                            const input = manageColsModal.querySelector(`input[data-col-id="${id}"]`);
                            if (originalCol && input) originalCol.label = input.value.trim() || 'Kh√¥ng t√™n';
                            return originalCol;
                        }).filter(Boolean);
                        
                        const sectionIndex = eventData.sections.findIndex(s => s.id === activeSectionIdForCols);
                        if (sectionIndex > -1) {
                            eventData.sections[sectionIndex].columns = reorderedCols;
                            await updateEvent({ sections: eventData.sections });
                            manageColsModal.classList.add('hidden');
                            showToast(`ƒê√£ c·∫≠p nh·∫≠t ${capitalizeFirst(itemType)}!`, 'success');
                        }
                    } else if (button.id === 'cancelManageColsBtn') {
                        manageColsModal.classList.add('hidden');
                    }
                });

                // --- GEMINI AI & EXPORT LISTENERS (Unchanged) ---
                cancelGeminiSuggestBtn.addEventListener('click', () => geminiSuggestModal.classList.add('hidden'));
                getGeminiSuggestionsBtn.addEventListener('click', async () => {
                    const userPrompt = geminiPrompt.value.trim();
                    if (!userPrompt) return showToast('Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ s·ª± ki·ªán.', 'error');

                    const selectedSectionId = geminiSectionSelector.value;
                    const section = eventData.sections.find(s => s.id === selectedSectionId);
                    if (!section) return showToast('Kh√¥ng t√¨m th·∫•y m·ª•c ƒë√£ ch·ªçn.', 'error');

                    geminiLoading.classList.remove('hidden');
                    getGeminiSuggestionsBtn.disabled = true;
                    resetGeminiSuggestionsBtn.classList.add('hidden');
                    addSuggestionsBtn.classList.add('hidden');
                    geminiSuggestionsContainer.innerHTML = '';

                    try {
                        const columnNames = section.columns.map(c => `"${c.label}"`).join(', ');
                        const fullPrompt = `V·ªõi ch·ªß ƒë·ªÅ s·ª± ki·ªán l√† "${userPrompt}", h√£y t·∫°o 5 g·ª£i √Ω n·ªôi dung cho m·ªôt b·∫£ng b√°o c√°o c√≥ c√°c c·ªôt sau: ${columnNames}. Tr·∫£ l·ªùi b·∫±ng m·ªôt m·∫£ng JSON h·ª£p l·ªá, trong ƒë√≥ m·ªói ƒë·ªëi t∆∞·ª£ng c√≥ c√°c kh√≥a (key) l√† ID c·ªôt t∆∞∆°ng ·ª©ng: ${section.columns.map(c => `"${c.id}"`).join(', ')}. Ch·ªâ tr·∫£ v·ªÅ m·∫£ng JSON, kh√¥ng c√≥ b·∫•t k·ª≥ vƒÉn b·∫£n gi·∫£i th√≠ch n√†o kh√°c.`;
                        
                        const schemaProperties = {};
                        section.columns.forEach(col => { schemaProperties[col.id] = { type: "STRING" }; });

                        const payload = {
                            contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: schemaProperties } }
                            }
                        };
                        
                        const apiKey = "";
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`L·ªói API: ${response.status} ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        let rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (typeof rawText !== 'string' || rawText.trim() === '') {
                            console.error("API did not return valid text.", result);
                            throw new Error("AI kh√¥ng tr·∫£ v·ªÅ ph·∫£n h·ªìi vƒÉn b·∫£n h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.");
                        }

                        let suggestions;
                        try {
                            suggestions = JSON.parse(rawText);
                        } catch (e) {
                            console.error("Failed to parse AI response as JSON:", rawText);
                            throw new Error("Ph·∫£n h·ªìi c·ªßa AI kh√¥ng ph·∫£i l√† ƒë·ªãnh d·∫°ng JSON h·ª£p l·ªá.");
                        }

                        if (!Array.isArray(suggestions)) {
                            console.error("AI response is not an array:", suggestions);
                            throw new Error("Ph·∫£n h·ªìi c·ªßa AI kh√¥ng ph·∫£i l√† m·ªôt danh s√°ch (m·∫£ng).");
                        }

                        geminiSuggestionsContainer.innerHTML = suggestions.map((s, index) => `
                            <label for="suggestion-${index}" class="flex items-start p-3 bg-gray-700 rounded-lg hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox" id="suggestion-${index}" class="mt-1 mr-3 h-4 w-4 rounded border-gray-500 text-purple-600 focus:ring-purple-500" checked>
                                <div class="flex-1">
                                    ${section.columns.map(c => `<p><strong class="font-semibold text-purple-300">${c.label}:</strong> ${s[c.id] || ''}</p>`).join('')}
                                </div>
                            </label>
                        `).join('');
                        
                        geminiSuggestionsContainer.querySelectorAll('input[type="checkbox"]').forEach((checkbox, index) => {
                            checkbox.dataset.suggestion = JSON.stringify(suggestions[index]);
                        });

                        addSuggestionsBtn.classList.remove('hidden');

                    } catch (error) {
                        console.error("Gemini AI Error:", error);
                        showToast(error.message || "Kh√¥ng th·ªÉ t·∫°o g·ª£i √Ω. Vui l√≤ng th·ª≠ l·∫°i.", "error");
                        geminiSuggestionsContainer.innerHTML = `<p class="text-red-400 text-center">${error.message}</p>`;
                    } finally {
                        geminiLoading.classList.add('hidden');
                        getGeminiSuggestionsBtn.disabled = false;
                        resetGeminiSuggestionsBtn.classList.remove('hidden');
                    }
                });
                addSuggestionsBtn.addEventListener('click', async () => {
                    const selectedSectionId = geminiSectionSelector.value;
                    const sectionIndex = eventData.sections.findIndex(s => s.id === selectedSectionId);
                    if (sectionIndex === -1) return;

                    const checkedBoxes = geminiSuggestionsContainer.querySelectorAll('input:checked');
                    if (checkedBoxes.length === 0) return showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt g·ª£i √Ω.', 'error');

                    const newRegistrationsBatch = [];
                    let parsingError = false;

                    checkedBoxes.forEach(box => {
                        if (parsingError) return;
                        try {
                            const suggestionData = JSON.parse(box.dataset.suggestion);
                            const newRegistration = { id: `reg_${Date.now()}_${Math.random()}`, values: suggestionData };
                            newRegistrationsBatch.push(newRegistration);
                        } catch (e) {
                            console.error("Failed to parse suggestion data from checkbox:", box.dataset.suggestion, e);
                            showToast("L·ªói d·ªØ li·ªáu g·ª£i √Ω. Kh√¥ng th·ªÉ th√™m m·ª•c.", "error");
                            parsingError = true;
                        }
                    });

                    if (parsingError) return;

                    if (!eventData.sections[sectionIndex].registrations) {
                        eventData.sections[sectionIndex].registrations = [];
                    }
                    eventData.sections[sectionIndex].registrations.push(...newRegistrationsBatch);

                    await updateEvent({ sections: eventData.sections });
                    showToast(`${checkedBoxes.length} g·ª£i √Ω ƒë√£ ƒë∆∞·ª£c th√™m!`, 'success');
                    geminiSuggestModal.classList.add('hidden');
                    resetGeminiSuggestionsBtn.click();
                });
                resetGeminiSuggestionsBtn.addEventListener('click', () => {
                    geminiPrompt.value = '';
                    geminiSuggestionsContainer.innerHTML = '';
                    addSuggestionsBtn.classList.add('hidden');
                    resetGeminiSuggestionsBtn.classList.add('hidden');
                    getGeminiSuggestionsBtn.classList.remove('hidden');
                    getGeminiSuggestionsBtn.disabled = false;
                });
                document.getElementById('cancelExportBtn').addEventListener('click', () => exportOptionsModal.classList.add('hidden'));
                document.getElementById('logoUploader').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            uploadedLogo = event.target.result;
                            const preview = document.getElementById('logoPreview');
                            preview.src = uploadedLogo;
                            preview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
                document.getElementById('exportJpgBtn').addEventListener('click', () => exportHandler('jpg'));
                document.getElementById('exportPdfBtn').addEventListener('click', () => exportHandler('pdf'));
                document.getElementById('exportXlsxBtn').addEventListener('click', () => exportHandler('xlsx'));
                document.getElementById('exportTxtBtn').addEventListener('click', () => exportHandler('txt'));

            } catch(e) {
                console.error("Error initializing app:", e);
                showToast("ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng khi kh·ªüi t·∫°o ·ª©ng d·ª•ng.", "error");
            }
        });

        function setupInitialView() {
            if (window.innerWidth < 1024) {
                document.getElementById('form-panel').classList.add('hidden');
                document.getElementById('stats-panel').classList.add('hidden');
                document.getElementById('sections-container').classList.remove('hidden');
                setupMobileNavigation();
            }
        }

        function setupMobileNavigation() {
            const mobileNav = document.getElementById('mobile-nav');
            const mobileTabs = mobileNav.querySelectorAll('.mobile-tab');
            const panels = {
                'form-panel': document.getElementById('form-panel'),
                'sections-container': document.getElementById('sections-container'),
                'stats-panel': document.getElementById('stats-panel')
            };
            const showMobilePanel = (viewId) => {
                Object.values(panels).forEach(panel => panel && panel.classList.add('hidden'));
                if(panels[viewId]) panels[viewId].classList.remove('hidden');
                mobileTabs.forEach(t => t.classList.toggle('active', t.dataset.view === viewId));
            };
            mobileNav.addEventListener('click', (e) => {
                const tab = e.target.closest('.mobile-tab');
                if (tab) showMobilePanel(tab.dataset.view);
            });
            showMobilePanel('sections-container');
        }
        
        window.addEventListener('hashchange', async () => {
            const eventId = window.location.hash.substring(1);
            if (eventId && eventId !== currentEventId) {
                await loadEvent(eventId);
            } else if (!eventId && user) {
                listenToUserEvents(true);
            }
        });

        async function exportHandler(type) {
            showToast(`ƒêang chu·∫©n b·ªã xu·∫•t file ${type.toUpperCase()}...`, 'info');
            if (!eventData || !eventData.sections || eventData.sections.length === 0) {
                showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.', 'error');
                return;
            }

            const printableReportContainer = document.getElementById('printable-report');
            printableReportContainer.innerHTML = '';
            exportOptionsModal.classList.add('hidden');

            const signerName = document.getElementById('signerNameInput').value.trim();
            const logoSrc = uploadedLogo || 'https://thiensutinhquang.github.io/Admin/icons/icon-192.png';
            const eventName = eventData.name || 'B√°o c√°o S·ª± ki·ªán';

            try {
                if (type === 'jpg' || type === 'pdf') {
                    let reportHtmlContent = `
                        <div style="background-color: #0000FF; color: #FFFFFF; padding: 40px; font-family: 'Inter', sans-serif; min-height: 100vh; box-sizing: border-box;">
                            <div style="text-align: center; margin-bottom: 40px;">
                                <img src="${logoSrc}" style="height: 100px; margin: 0 auto 20px; display: block; border-radius: 8px;">
                                <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">${eventName}</h1>
                                <p style="font-size: 24px; color: #facc15;">Gia ƒë√¨nh Minh S∆∞ T·ªãnh Quang</p>
                            </div>
                            <div style="margin-bottom: 40px;">
                                <p style="font-size: 18px; margin-bottom: 10px;"><strong>Ng√†y xu·∫•t:</strong> ${new Date().toLocaleDateString('vi-VN')}</p>
                                ${signerName ? `<p style="font-size: 18px;"><strong>Ng∆∞·ªùi k√Ω:</strong> ${signerName}</p>` : ''}
                            </div>
                        `;

                    eventData.sections.forEach(section => {
                        reportHtmlContent += `
                            <div style="margin-bottom: 40px; padding: 20px; background-color: rgba(255,255,255,0.1); border-radius: 12px;">
                                <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 20px; text-align: center;">${section.title}</h2>
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; color: white;">
                                    <thead>
                                        <tr style="background-color: rgba(255,255,255,0.2); font-weight: bold;">
                                            <th style="padding: 12px; border: 1px solid rgba(255,255,255,0.3);">STT</th>
                                            ${section.columns.map(c => `<th style="padding: 12px; border: 1px solid rgba(255,255,255,0.3);">${c.label}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(section.registrations || []).map((reg, index) => `
                                            <tr>
                                                <td style="padding: 12px; border: 1px solid rgba(255,255,255,0.3); text-align: center;">${index + 1}</td>
                                                ${section.columns.map(c => `<td style="padding: 12px; border: 1px solid rgba(255,255,255,0.3);">${reg.values[c.id] || ''}</td>`).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    });
                    reportHtmlContent += `</div>`;
                    printableReportContainer.innerHTML = reportHtmlContent;
                    printableReportContainer.classList.add('visible-for-capture');

                    const canvas = await html2canvas(printableReportContainer, { scale: 2, useCORS: true, backgroundColor: null });
                    printableReportContainer.classList.remove('visible-for-capture');
                    
                    if (type === 'jpg') {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.download = `${eventData.name || 'bao_cao'}.jpg`;
                        link.click();
                        showToast('Xu·∫•t JPG th√†nh c√¥ng!', 'success');
                    } else if (type === 'pdf') {
                        const imgData = canvas.toDataURL('image/jpeg', 0.9);
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const imgProps = pdf.getImageProperties(imgData);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        let heightLeft = pdfHeight;
                        let position = 0;
                        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                        heightLeft -= pdf.internal.pageSize.getHeight();
                        while (heightLeft > 0) {
                            position = heightLeft - pdfHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, pdfHeight);
                            heightLeft -= pdf.internal.pageSize.getHeight();
                        }
                        pdf.save(`${eventData.name || 'bao_cao'}.pdf`);
                        showToast('Xu·∫•t PDF th√†nh c√¥ng!', 'success');
                    }
                } else if (type === 'xlsx') {
                    const ws_data = [];
                    eventData.sections.forEach(section => {
                        ws_data.push([section.title]);
                        ws_data.push(['STT', ...section.columns.map(c => c.label)]);
                        section.registrations.forEach((reg, index) => {
                            ws_data.push([index + 1, ...section.columns.map(c => reg.values[c.id] || '')]);
                        });
                        ws_data.push([]);
                    });
                    const ws = XLSX.utils.aoa_to_sheet(ws_data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "B√°o c√°o");
                    XLSX.writeFile(wb, `${eventData.name || 'bao_cao'}.xlsx`);
                    showToast('Xu·∫•t Excel th√†nh c√¥ng!', 'success');
                } else if (type === 'txt') {
                    let txtContent = '';
                    eventData.sections.forEach(section => {
                        txtContent += `--- ${section.title} ---\n`;
                        txtContent += `STT\t${section.columns.map(c => c.label).join('\t')}\n`;
                        section.registrations.forEach((reg, index) => {
                            txtContent += `${index + 1}\t${section.columns.map(c => reg.values[c.id] || '').join('\t')}\n`;
                        });
                        txtContent += '\n';
                    });
                    const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${eventData.name || 'bao_cao'}.txt`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    showToast('Xu·∫•t TXT th√†nh c√¥ng!', 'success');
                }
            } catch (error) {
                console.error(`Error exporting ${type.toUpperCase()}:`, error);
                showToast(`L·ªói khi xu·∫•t ${type.toUpperCase()}.`, 'error');
            } finally {
                printableReportContainer.classList.remove('visible-for-capture');
                printableReportContainer.innerHTML = '';
            }
        }
    </script>
</body>
</html>
